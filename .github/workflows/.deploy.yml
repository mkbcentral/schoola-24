name: üöÄ Deploy via SSH SCHOOLA APP V2
on:
  push:
    branches:
      - main # D√©clenche le workflow sur chaque push sur la branche main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4
        # R√©cup√®re le code source du d√©p√¥t

      - name: ‚öôÔ∏è Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
        # Installe PHP 8.3 sur l'environnement GitHub Actions


      - name: ÔøΩ Debug - Test SSH connection and verify path
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "=== Current directory ==="
            pwd
            echo "=== Home directory contents ==="
            ls -la ~
            echo "=== Target path info ==="
            echo "Deploy path should be: ${{ secrets.DEPLOY_PATH }}"
            ls -la ${{ secrets.DEPLOY_PATH }} || echo "Path does not exist or not accessible"
            echo "=== Creating/verifying deploy directory ==="
            mkdir -p ${{ secrets.DEPLOY_PATH }}
            chmod 755 ${{ secrets.DEPLOY_PATH }}
            echo "Deploy directory ready!"
        # Test la connexion SSH et v√©rifie les chemins

      - name: ÔøΩüöÄ Deploy to Hostinger via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # Cr√©er un r√©pertoire temporaire pour le d√©ploiement
            TEMP_DIR="/tmp/schoola-deploy-$(date +%s)"
            mkdir -p $TEMP_DIR
            cd $TEMP_DIR

            # Cloner le repository
            git clone --depth 1 --branch main https://github.com/${{ github.repository }}.git .

            # Installer les d√©pendances
            composer install --no-dev --optimize-autoloader --no-interaction

            # Synchroniser vers le dossier de d√©ploiement
            mkdir -p ${{ secrets.DEPLOY_PATH }}
            rsync -av --delete \
              --exclude='.git' \
              --exclude='node_modules' \
              --exclude='.env' \
              --exclude='storage/logs/*' \
              ./ ${{ secrets.DEPLOY_PATH }}/

            # Nettoyer
            rm -rf $TEMP_DIR
        # Clone, build et d√©ploie via SSH directement sur le serveur

      - name: üîß Run artisan commands remotely
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            php artisan migrate
            php artisan db:seed --force
            php artisan key:generate
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize:clear
        # Ex√©cute des commandes Laravel sur le serveur distant (migrations, cache, etc.)

      - name: üìÑ Copy index.php, .htaccess and robots.txt to root
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            [ -f ${{ secrets.DEPLOY_PATH }}/index.php ] || cp ${{ secrets.DEPLOY_PATH }}/public/index.php ${{ secrets.DEPLOY_PATH }}/index.php
            [ -f ${{ secrets.DEPLOY_PATH }}/robots.txt ] || cp ${{ secrets.DEPLOY_PATH }}/public/robots.txt ${{ secrets.DEPLOY_PATH }}/robots.txt
            [ -f ${{ secrets.DEPLOY_PATH }}/.htaccess ] || cp ${{ secrets.DEPLOY_PATH }}/public/.htaccess ${{ secrets.DEPLOY_PATH }}/.htaccess
        # Copie certains fichiers du dossier public √† la racine si besoin
